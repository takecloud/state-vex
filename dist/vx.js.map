{"version":3,"file":"vx.js","sources":["../src/store.js","../src/dep.js","../src/index.js"],"sourcesContent":["function createStore (wrapper, key) {\r\n  const newStore = Object.create(null)\r\n  if (wrapper && key) {\r\n    wrapper.key = newStore\r\n    return wrapper\r\n  } else {\r\n    return newStore\r\n  }\r\n}\r\n\r\nexport default {\r\n  createStore\r\n}\r\n","let depID = 1\r\nlet watcher = null\r\n\r\nclass Dep {\r\n  constructor () {\r\n    this.id = depID++\r\n    this.subs = []\r\n  }\r\n  addSub (fn) {\r\n    this.subs[this.subs.length] = fn\r\n  }\r\n  delSub (fn) {\r\n    this.subs.splice(\r\n      this.subs.findIndex(x => x === fn), 1\r\n    )\r\n  }\r\n  clear () {\r\n    this.subs.length = 0\r\n  }\r\n  collect (fn = watcher) {\r\n    if (fn && !this.subs.find(x => x === fn)) {\r\n      this.addSub(fn)\r\n    }\r\n  }\r\n  notify (newVal, oldVal) {\r\n    this.subs.forEach(func => func(newVal, oldVal))\r\n  }\r\n}\r\n\r\n// 如果不使用打包工具的话, 这样写要比 Dep.watcher.val 的形式舒服些\r\nObject.defineProperty(Dep, 'watcher', {\r\n  enumerable: false,\r\n  configurable: true,\r\n  get: () => {\r\n    return watcher\r\n  },\r\n  set: newWather => {\r\n    watcher = newWather\r\n  }\r\n})\r\n\r\nexport default Dep\r\n","/** 一个非常简单的响应式状态管理 本意用来实现小程序中模板对全局对象中某个属性的订阅 */\r\n\r\nimport Store from './store'\r\nimport Dep from './dep'\r\n\r\nlet VXID = 1\r\nlet handleDep = null\r\n\r\nfunction walkChains (key, obj, fn) {\r\n  const segments = key.split('.')\r\n  let deepObj = obj\r\n  while (segments.length) {\r\n    deepObj = deepObj[segments.shift()]\r\n    fn && fn()\r\n  }\r\n}\r\n\r\nclass VX {\r\n  constructor () {\r\n    this.id = VXID++\r\n    this.store = Store.createStore()\r\n  }\r\n  watch (key, fn, options = { immediately: false }, obj = this.store) {\r\n    Dep.watcher = fn\r\n    walkChains(key, obj)\r\n    Dep.watcher = null\r\n    options.immediately && fn(options.defaultParams)\r\n  }\r\n  unwatch (key, fn, obj = this.store) {\r\n    walkChains(key, obj, () => handleDep.delSub(fn))\r\n  }\r\n  unwatchAll (key, fn, obj = this.store) {\r\n    walkChains(key, obj, () => handleDep.clear())\r\n  }\r\n  set (key, val, options = {}, obj = this.store) {\r\n    // console.log(key, val, obj, this)\r\n\r\n    /** 对象值链 */\r\n    const segments = key.split('.')\r\n    while (segments.length > 1) {\r\n      const handleKey = segments.shift()\r\n      const handleVal = obj[handleKey]\r\n      if (typeof handleVal === 'object') {\r\n        obj = handleVal\r\n      } else if (!handleVal) {\r\n        obj = (\r\n          key = handleKey,\r\n          obj[handleKey] = {},\r\n          obj[handleKey]\r\n        )\r\n      } else {\r\n        console.warn('already has val')\r\n      }\r\n    }\r\n    key = segments[0]\r\n    /** walk */\r\n    if (val && typeof val === 'object' && !(val instanceof Array)) {\r\n      Object.entries(val).map(entry => {\r\n        const [k, v] = entry\r\n        this.set(k, v, {}, val)\r\n      })\r\n    }\r\n    /** defineProperty */\r\n    const dep = new Dep()\r\n    Object.defineProperty(obj, key, {\r\n      enumerable: true,\r\n      configurable: true,\r\n      get: () => {\r\n        handleDep = dep\r\n        handleDep.collect()\r\n        return options.formatter ? options.formatter(val) : val\r\n      },\r\n      set: newVal => {\r\n        if (newVal === val) {\r\n          return\r\n        }\r\n        dep.notify(newVal, val)\r\n        val = newVal\r\n      }\r\n    })\r\n  }\r\n  del (key, obj = this.store) {\r\n    walkChains(key, obj, () => handleDep.clear())\r\n    delete obj[key]\r\n  }\r\n  delAll (obj = this.store) {\r\n    Object.keys(obj).map(key => this.del(key))\r\n  }\r\n}\r\n\r\nexport default VX\r\n"],"names":["const","let","this"],"mappings":";;AAAA,SAAS,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE;EAClCA,IAAM,QAAQ,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,EAAC;EACpC,IAAI,OAAO,IAAI,GAAG,EAAE;IAClB,OAAO,CAAC,GAAG,GAAG,SAAQ;IACtB,OAAO,OAAO;GACf,MAAM;IACL,OAAO,QAAQ;GAChB;CACF;;AAED,YAAe;eACb,WAAW;CACZ;;ACZDC,IAAI,KAAK,GAAG,EAAC;AACbA,IAAI,OAAO,GAAG,KAAI;;AAElB,IAAM,GAAG,GACP,YAAW,IAAI;EACf,IAAM,CAAC,EAAE,GAAG,KAAK,GAAE;EACnB,IAAM,CAAC,IAAI,GAAG,GAAE;EACf;AACH,cAAE,MAAM,oBAAE,EAAE,EAAE;EACZ,IAAM,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,GAAE;EACjC;AACH,cAAE,MAAM,oBAAE,EAAE,EAAE;EACZ,IAAM,CAAC,IAAI,CAAC,MAAM;IAChB,IAAM,CAAC,IAAI,CAAC,SAAS,WAAC,GAAE,SAAG,CAAC,KAAK,KAAE,CAAC,EAAE,CAAC;IACtC;EACF;AACH,cAAE,KAAK,qBAAI;EACT,IAAM,CAAC,IAAI,CAAC,MAAM,GAAG,EAAC;EACrB;AACH,cAAE,OAAO,qBAAE,EAAY,EAAE;2BAAZ,GAAG;;EACd,IAAM,EAAE,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,WAAC,GAAE,SAAG,CAAC,KAAK,KAAE,CAAC,EAAE;IAC1C,IAAM,CAAC,MAAM,CAAC,EAAE,EAAC;GAChB;EACF;AACH,cAAE,MAAM,oBAAE,MAAM,EAAE,MAAM,EAAE;EACxB,IAAM,CAAC,IAAI,CAAC,OAAO,WAAC,MAAK,SAAG,IAAI,CAAC,MAAM,EAAE,MAAM,IAAC,EAAC;CAChD,CACF;;;AAGD,MAAM,CAAC,cAAc,CAAC,GAAG,EAAE,SAAS,EAAE;EACpC,UAAU,EAAE,KAAK;EACjB,YAAY,EAAE,IAAI;EAClB,GAAG,cAAK;IACN,OAAO,OAAO;GACf;EACD,GAAG,YAAE,WAAU;IACb,OAAO,GAAG,UAAS;GACpB;CACF,CAAC;;ACvCF;;AAEA,AAGAA,IAAI,IAAI,GAAG,EAAC;AACZA,IAAI,SAAS,GAAG,KAAI;;AAEpB,SAAS,UAAU,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE,EAAE;EACjCD,IAAM,QAAQ,GAAG,GAAG,CAAC,KAAK,CAAC,GAAG,EAAC;EAC/BC,IAAI,OAAO,GAAG,IAAG;EACjB,OAAO,QAAQ,CAAC,MAAM,EAAE;IACtB,OAAO,GAAG,OAAO,CAAC,QAAQ,CAAC,KAAK,EAAE,EAAC;IACnC,EAAE,IAAI,EAAE,GAAE;GACX;CACF;;AAED,IAAM,EAAE,GACN,WAAW,IAAI;EACf,IAAM,CAAC,EAAE,GAAG,IAAI,GAAE;EAClB,IAAM,CAAC,KAAK,GAAG,KAAK,CAAC,WAAW,GAAE;EACjC;AACH,aAAE,KAAK,mBAAE,GAAG,EAAE,EAAE,EAAE,OAAgC,EAAE,GAAgB,EAAE;qCAA7C,GAAG,EAAE,WAAW,EAAE,KAAK;6BAAO,GAAG,IAAI,CAAC;;EAC7D,GAAK,CAAC,OAAO,GAAG,GAAE;EAClB,UAAY,CAAC,GAAG,EAAE,GAAG,EAAC;EACtB,GAAK,CAAC,OAAO,GAAG,KAAI;EACpB,OAAS,CAAC,WAAW,IAAI,EAAE,CAAC,OAAO,CAAC,aAAa,EAAC;EACjD;AACH,aAAE,OAAO,qBAAE,GAAG,EAAE,EAAE,EAAE,GAAgB,EAAE;6BAAf,GAAG,IAAI,CAAC;;EAC7B,UAAY,CAAC,GAAG,EAAE,GAAG,cAAK,SAAG,SAAS,CAAC,MAAM,CAAC,EAAE,IAAC,EAAC;EACjD;AACH,aAAE,UAAU,wBAAE,GAAG,EAAE,EAAE,EAAE,GAAgB,EAAE;6BAAf,GAAG,IAAI,CAAC;;EAChC,UAAY,CAAC,GAAG,EAAE,GAAG,cAAK,SAAG,SAAS,CAAC,KAAK,KAAE,EAAC;EAC9C;AACH,aAAE,GAAG,iBAAE,GAAG,EAAE,GAAG,EAAE,OAAY,EAAE,GAAgB,EAAE;;qCAAzB,GAAG;6BAAO,GAAG,IAAI,CAAC;;;;;EAIxC,IAAQ,QAAQ,GAAG,GAAG,CAAC,KAAK,CAAC,GAAG,EAAC;EACjC,OAAS,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE;IAC5B,IAAQ,SAAS,GAAG,QAAQ,CAAC,KAAK,GAAE;IACpC,IAAQ,SAAS,GAAG,GAAG,CAAC,SAAS,EAAC;IAClC,IAAM,OAAO,SAAS,KAAK,QAAQ,EAAE;MACnC,GAAK,GAAG,UAAS;KAChB,MAAM,IAAI,CAAC,SAAS,EAAE;MACvB,GAAK;QACH,GAAK,GAAG,SAAS,EACjB,GAAK,CAAC,SAAS,CAAC,GAAG,EAAE,EACrB,GAAK,CAAC,SAAS,CAAC,AAClB,EAAG;KACF,MAAM;MACP,OAAS,CAAC,IAAI,CAAC,iBAAiB,EAAC;KAChC;GACF;EACH,GAAK,GAAG,QAAQ,CAAC,CAAC,EAAC;;EAEnB,IAAM,GAAG,IAAI,OAAO,GAAG,KAAK,QAAQ,IAAI,EAAE,GAAG,YAAY,KAAK,CAAC,EAAE;IAC/D,MAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,GAAG,WAAC,OAAM;MAC9B,IAAS;YAAG,CAAC,YAAS;MACtB,MAAM,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,EAAE,GAAG,EAAC;KACxB,EAAC;GACH;;EAEH,IAAQ,GAAG,GAAG,IAAI,GAAG,GAAE;EACvB,MAAQ,CAAC,cAAc,CAAC,GAAG,EAAE,GAAG,EAAE;IAChC,UAAY,EAAE,IAAI;IAClB,YAAc,EAAE,IAAI;IACpB,GAAK,cAAK;MACR,SAAW,GAAG,IAAG;MACjB,SAAW,CAAC,OAAO,GAAE;MACrB,OAAS,OAAO,CAAC,SAAS,GAAG,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC,GAAG,GAAG;KACxD;IACH,GAAK,YAAE,QAAO;MACZ,IAAM,MAAM,KAAK,GAAG,EAAE;QACpB,MAAQ;OACP;MACH,GAAK,CAAC,MAAM,CAAC,MAAM,EAAE,GAAG,EAAC;MACzB,GAAK,GAAG,OAAM;KACb;GACF,EAAC;EACH;AACH,aAAE,GAAG,iBAAE,GAAG,EAAE,GAAgB,EAAE;6BAAf,GAAG,IAAI,CAAC;;EACrB,UAAY,CAAC,GAAG,EAAE,GAAG,cAAK,SAAG,SAAS,CAAC,KAAK,KAAE,EAAC;EAC/C,OAAS,GAAG,CAAC,GAAG,EAAC;EAChB;AACH,aAAE,MAAM,oBAAE,GAAgB,EAAE;;6BAAf,GAAG,IAAI,CAAC;;EACnB,MAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,GAAG,WAAC,KAAI,SAAGC,MAAI,CAAC,GAAG,CAAC,GAAG,IAAC,EAAC;CAC3C,CACF;;;;"}